@model PeopleEvaluationVM

<div class="modal-header">
    <h5 class="modal-title" id="exampleModalLabel">Asignación de personas</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<div class="modal-body">
    <input type="hidden" asp-for="Id" />
    <span asp-validation-for="PersonEvaluations" class="text-danger small"></span>
    <table class="table w-100" id="usersTable">
        <thead style="background-color:yellowgreen; color:white">
            <tr>
                <th></th>
                <th class="d-none"></th>
                <th>
                    @Html.DisplayNameFor(model => model.PersonEvaluations.FirstOrDefault().Person.FullName)
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.PersonEvaluations)
            {
                <tr class="@((item.IsSelected) ? "assigned" : "")">
                    <td></td>
                    <td class="d-none">@Html.DisplayFor(modelItem => item.PersonId)</td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Person.FullName)
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" id="cancel" data-dismiss="modal">Cancelar</button>
    <button type="button" class="btn btn-primary" id="assign">Asignar</button>
</div>

<script>
    $(document).ready(function () {
        const usersTable = $('#usersTable').DataTable({
            columnDefs: [{
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            }],
            select: {
                style: 'multi',
                selector: 'td:first-child'
            },
            language: {
                url: '/lib/datatables.net/Spanish.json'
            },
            order: [[1, 'asc']]
        });

        usersTable.select().init();
        usersTable.rows('.assigned').select();

        $('#assign').on("click", function () {
            $(this).prop('disabled', true);
            $('#cancel').prop('disabled', true);
            let people = usersTable.rows({ selected: true }).data();

            let Id = $('#Id').val();
            let personEvaluations = new Array();
            for (let i = 0; i < people.length; i++) {
                personEvaluations.push({ EvaluationId: Id, PersonId: people[i][1], IsSelected: true });
            }

            $.ajax({
                url: '@Url.Action("AssignPeople", "Evaluations")',
                method: 'POST',
                data: {
                    Id: Id,
                    PersonEvaluations: personEvaluations
                },
                success: function (data) {
                    //if (!data.startsWith("<div"))
                    $('#assign-modal').modal('show');
                    if (data.lastIndexOf("<div", 6) != -1) {
                        $('.modal-content').html(data);
                        $('#assign-modal').modal('show');
                        $('#assign').prop('disabled', false);
                        $('#cancel').prop('disabled', false);
                    }
                    else {
                        location.reload();
                    }
                },
                error: function (data) {
                    console.log(data);
                    alert("Ocurrió un error, intente más tarde por favor");
                }
            });
        })
    });

</script>